Exercise 2: Deploying NGINX [Plus](https://www.nginx.com/products/nginx/) web server with CICD
----------------------------------------------------------------------------------------------

This lab exercise will guide us through deploying an NGINX Plus Web
server through a CICD Pipeline, a best practices for DevOps teams to
implement, for delivering code changes more frequently and reliably.

We will be making simple changes to our web application and rapidly push
the new code to live environments. For this use case, we will again be
building and pushing Docker containers as our deployment artifact.

The diagram below depicts the workflow from code to deployment. Our CICD
Pipeline docker image to the container registry but could easily be
extended to deploy a container with a new application code to a live
environment. We will see in this exercise that the push to Staging
environment is automatic while the push to our production environment
requires a human trigger

![A close up of a map Description automatically
generated](./media/image1.png){width="6.5in"
height="5.35416447944007in"}

### Task 1: Make new code commit, push changes and deploy to Staging and Production

In this example, we will make a simple change in updating the phone
image on the homepage. We will then commit our changes and push the new
code to our Gitlab repository; this will automatically trigger a CICD
pipeline.

A successful build will result in storing the Docker container artifact
in a private Container Registry; this is the new stable build of NGINX
Plus containing the new web application code.

The last phase of the CICD Pipeline will deploy the new container to our
Staging Server automatically but wait for a human trigger to deploy the
containers to Production. Note that we will deploy four instances (four
containers) to Production to illustrate NGINX Plus as a Load Balancer in
the next exercise

1.  Open the GitHub Desktop client and make sure the current repository
    selected is **\`gitlabappster\`.**

From the same screen now click the **"Open in Visual Studio Code"**
button to start editing our appster web application code

![A screenshot of a cell phone Description automatically
generated](./media/image2.png){width="6.5in" height="3.84375in"}

Now that Visual Studio Code is open, expand the tree under '**gitlabappster -\> etc -\> nginx -\> html**. Once the tree has been opened, find '**index.html**' file and right click on it. A menu will open up. Select: **"Reveal in File explorer"** to open it up in windows explorer.
========================================================================================================================================================================================================================================================================================

![A screen shot of a computer Description automatically
generated](./media/image3.png){width="6.5in"
height="4.916666666666667in"}

3.  Once **windows explorer** has opened at the location of the file,
    you will see the folder with '**index.html**' listed. Go ahead and
    double-click **'index.html**' to open that file in a browser (Google
    Chrome.)

![A screenshot of a cell phone Description automatically
generated](./media/image4.png){width="6.5in"
height="2.5208333333333335in"}

4.  After the double-click on **'index.html',** and opening the webpage
    in the web browser, you will see the current webpage displaying the
    Appster application with a dated iPhone 7 image. **Go ahead and
    leave this web browser page open.**

![A screenshot of a cell phone Description automatically
generated](./media/image5.png){width="5.0in"
height="3.3854166666666665in"}

5.  Go back to Visual Studio code editor to make edits to this file.
    This time, open that same 'index.html' file (click to open it in
    visual studio code.)\
    \
    Once the file is open, we are now going to find and replace the
    current iPhone image (currently set to **\`iphone\_7.png\`**) and
    change it to **\`iphone\_x.png.\`** Hit **Ctrl+F**, which opens the
    find window and type in iphone\_7.png. You should have two hits
    (just to the right of the find window). 

Search and replace all instances of '**iphone\_7.png**' to
'**iphone\_x.png'. Update all two instances of that image**

![A screenshot of a computer screen Description automatically
generated](./media/image6.png){width="6.5in"
height="2.3645833333333335in"}

6.  Once you have edited **index.html** and replaced both instances of
    '**iphone\_7.png' with** **iphone\_x.png'**, go ahead and save the
    file. You can navigate to file -\> save or you can use the shortcut,
    ctrl+s. (NOTE: Do not change the file name. Keep it the same.)

7.  Open or switch back to the** GitHub Desktop Client** and see the
    tracked changes made.

The GitHub Desktop Client has automatically tracked the changes that
were made on \`**index.html\`** and is highlighting those exact changes,
\`**iphone\_7.png\` **replaced** **with \`**iphone\_x.png\`.**

8.  We now can push these changes to our repository on GitLab. In the
    lower-left of the GitHub, Desktop Client provide a Commit title and
    notes before we can commit to master. 

You can see two boxes. Go ahead and type in the title field: \"**update
index.html\"**. 

Additionally, you can provide notes as well, type in the notes field:
\"**Update phone image**.\"

Once you fill in both boxes, click on **\'Commit to Master\' **and on
the next screen, press** \"Push to Origin\" **to push the new code
commit to our git repository on Gitlab.

![A screenshot of a social media post Description automatically generated](./media/image7.png){width="5.0in" height="3.59375in"}
================================================================================================================================

![A screenshot of a cell phone Description automatically
generated](./media/image8.png){width="5.0in"
height="3.6666666666666665in"}

9.  After you click on **\"Commit to Master,\"** you will be taken to
    the next page where we push our changes to our repository. Go and
    click **\"push origin,\"** which will now push our modified
    index.html file to our GitLab repository.

10. Open up the Appster repo on Gitlab, using the
    URI **https://gitlab.f5demolab.com/f5-demo-lab/gitlabappster**, or
    using the "**Appster**" shortcut provided. This is our repository,
    where we just pushed our modified **\`index.html\`** file to.

![A screenshot of a cell phone Description automatically
generated](./media/image9.png){width="6.5in" height="3.59375in"}

11. In the middle of the Appster repository, you will see the pipeline
    status icon next to the latest Commit SHA. When the pipeline
    currently in progress, you will see an **orange icon** (waiting to
    start) or a **blue circle** (running). Hopefully, we don't see
    a **red icon**, which indicates the pipeline has failed. We can
    click on the pipeline status icon to view the pipeline progress

![A screenshot of a social media post Description automatically
generated](./media/image10.png){width="6.5in"
height="4.510416666666667in"}

The next screen shows a high-level view of the pipeline triggered for
this commit. We can click on the pipeline status icon on this screen to
view the pipeline progress in greater detail.

![A screenshot of a cell phone Description automatically
generated](./media/image11.png){width="6.5in"
height="3.4895833333333335in"}

12. After clicking on the pipeline status icon, we can view the full
    pipeline. As you can see, we can now see our pipeline: **BUILD,
    TEST, PUSH, DEPLOY**, and **CLEANUP.** This pipeline was
    automatically triggered after we submitted our changes to index.html
    (when we clicked **'push origin.'**) and we can see at a high level
    the stages in the pipeline progressing

![A screenshot of a cell phone Description automatically
generated](./media/image12.png){width="6.5in" height="3.65625in"}

13. As part of our Continuous Delivery, deployment to Staging is
    automatic, but we have purposely injected the requirement for a
    human trigger for deployment to Production

Under the **DEPLOY** stage, we have the option to deploy to Production
manually. Go ahead and click on the little **'play' button** that is on
the '**deploy\_prod**' stage of the pipeline. This trigger will now
deploy our new Docker image to Production, with the new code showing the
updated image, **\`iphone\_x.png.\`**

![A screenshot of a cell phone Description automatically
generated](./media/image13.png){width="5.0in" height="2.78125in"}

![A screenshot of a cell phone Description automatically
generated](./media/image14.png){width="6.5in"
height="3.3645833333333335in"}

14. Browse to the server bookmarked in the **"Staging Servers"**
    bookmark folder to see the new web app code pushed to our Staging
    Server.

If our deployment to Production were also successful you would also see
the new web app code now deployed on **all four instances **in
Production; we can see that on any Web Servers bookmarked in
the **"Production Servers"** bookmark folder


You may need to reload the webpage if you currently have the webpage
open, or open the webpage in a **New incognito window (Ctrl + Shift +
N)** to bypass browser cache and view changes.

![A screenshot of a cell phone Description automatically
generated](./media/image15.png){width="6.5in" height="1.09375in"}

![A screenshot of a social media post Description automatically
generated](./media/image16.png){width="6.5in"
height="1.6770833333333333in"}

**Before:**

![](./media/image17.png "Inserting image..."){width="6.5in"
height="4.979166666666667in"}

**After new code commit:**

![A screenshot of a cell phone Description automatically
generated](./media/image18.png){width="6.5in" height="3.875in"}

### Task 2. Made new code commit, push changes using command line tools, and deploy

In this task, we will run through a similar process, but this time
achieve similar changes via a bash shell using Unix commands, a
different perspective to application development!

1.  Open git bash for windows using the "Git Bash" icon on the Windows
    desktop. Git Bash is a bash shell emulator, similar to what you see
    natively on Linux and Unix machines. If the git console font is too
    small to read, use Ctrl+ "+" to increase the font

![A picture containing drawing Description automatically
generated](./media/image19.png){width="1.6458333333333333in"
height="1.7291666666666667in"}

2.  Make sure you are in appster project root:
    \`**\~/Documents/Git/gitlabappster\`** . To get there, type the
    following command in the bash shell:

\`\`\`bash

cd \~/Documents/Git/gitlabappster

\`\`\`

You can then see the content of this project folder using the command:
**\`ls\`**

![A screenshot of a computer Description automatically
generated](./media/image20.png){width="6.5in"
height="4.114583333333333in"}

3.  We can change the background colors
    using [sed. ](https://www.gnu.org/software/sed/manual/sed.html)*sed* command
    in *UNIX* stands for Stream EDitor, and it can perform lots of
    function on file like searching, find and replace, insertion or
    deletion

Let's search and replace the
color **\`\#ffb300\`** with **\`\#512DA8\`**. The following command will
flip background colors - yellow to purple, purple to yellow:

\`\`\`bash

sed -i \'s/background:linear-gradient(-45deg,\#ffb300 33%,transparent
0),linear-gradient(-45deg,\#512da8/background:linear-gradient(-45deg,\#512da8
33%,transparent 0),linear-gradient(-45deg,\#ffb300/g\'
etc/nginx/html/css/bootstrap.min.css

\`\`\`

4.  We now can commit and push changes to the git code repository using
    git commands instead of the GitHub Desktop Client. Type the
    following three commands sequentially.

\`\`\`bash

git add .

git commit -m \"changed background from yellow to purple, purple to
yellow \" git push origin master

\`\`\`

If prompted for credentials, enter our Gitlab username and password:

udf / P\@ssw0rd20

![A screenshot of a cell phone Description automatically
generated](./media/image21.png){width="5.0in"
height="3.2083333333333335in"}

A successful push will look like the following

![A black sign with white text Description automatically
generated](./media/image22.png){width="6.5in"
height="2.0208333333333335in"}

5.  If you prefer the original color, we can revert the changes
    using [sed](https://www.gnu.org/software/sed/manual/sed.html) once
    again to search and replace \`**\#ffb300\`** with \`**\#512DA8\`**.

The following command will flip background colors - purple to yellow,
and yellow to purple. In fact, you can change the color to whatever you
like, replace purple (\`**\#512DA8\`**) to any other hex value you want.
You can use [color-hex](https://www.color-hex.com/) to find the color
code in hex.

For example:

\`\`\`bash

\# Flip background colors - purple to yellow, yellow to purple

sed -i \'s/background:linear-gradient(-45deg,\#512da8 33%,transparent
0),linear-gradient(-45deg,\#ffb300/background:linear-gradient(-45deg,\#ffb300
33%,transparent 0),linear-gradient(-45deg,\#512da8/g\'
etc/nginx/html/css/bootstrap.min.css

\`\`\`

6.  Once again, commit and push changes to code repository:

\`\`\`bash

git add .

git commit -m \"Eww! Revert background from purple to yellow, yellow to
purple \";

git push origin master

\`\`\`

Again, if prompted for credentials, use: udf / P\@ssw0rd20

![A screenshot of a cell phone Description automatically
generated](./media/image21.png){width="5.0in"
height="3.2083333333333335in"}

A successful push will look like the following

![A black sign with white text Description automatically
generated](./media/image22.png){width="6.5in"
height="2.0208333333333335in"}

7.  Browse back to the Appster repo on Gitlab, click the pipeline status
    icon to get back to the detailed pipeline progress page and watch
    the build process in real-time

![A screenshot of a cell phone Description automatically
generated](./media/image23.png){width="6.5in"
height="3.3854166666666665in"}

![A screenshot of a cell phone Description automatically
generated](./media/image24.png){width="6.5in"
height="3.2083333333333335in"}

8.  Once again, we check out the changes made in the new code deployment
    in a web browser. Remember that you may need to reload the webpage
    if you currently have the webpage open, or open the webpage in
    a **New incognito window (Ctrl + Shift + N) **to bypass browser
    cache and view updated changes

![](./media/image17.png "Inserting image..."){width="6.5in"
height="4.979166666666667in"}

![A screenshot of a cell phone Description automatically
generated](./media/image25.png){width="6.5in" height="5.0in"}
